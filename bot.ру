import os
import random
import asyncio
from aiogram import Bot, Dispatcher, Router
from aiogram.types import Message
from aiogram.filters import Command
from aiogram import F

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (—É–∫–∞–∑—ã–≤–∞–µ–º –≤ Render)
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN! –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ Environment Variables –Ω–∞ Render.")

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

# === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–î–ê–ù–ò–ô ===

def generate_math_tasks():
    tasks = []
    # 1. –°–ª–æ–∂–µ–Ω–∏–µ (–¥–æ 100)
    a, b = random.randint(10, 90), random.randint(10, 90)
    while a + b > 100:
        a, b = random.randint(10, 90), random.randint(10, 90)
    tasks.append(f"1. –†–µ—à–∏: {a} + {b} = ")

    # 2. –í—ã—á–∏—Ç–∞–Ω–∏–µ
    a = random.randint(50, 99)
    b = random.randint(10, a - 1)
    tasks.append(f"2. –†–µ—à–∏: {a} - {b} = ")

    # 3‚Äì4. –£–º–Ω–æ–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–µ–Ω–∏–µ
    x, y = random.randint(2, 9), random.randint(2, 9)
    tasks.append(f"3. {x} √ó {y} = ")
    div_num = random.randint(2, 9)
    div_res = random.randint(2, 10)
    tasks.append(f"4. {div_num * div_res} √∑ {div_num} = ")

    # 5. –ó–∞–¥–∞—á–∞ –Ω–∞ –¥–µ–ª–µ–Ω–∏–µ
    total = random.randint(12, 36)
    groups = random.choice([2, 3, 4, 6])
    tasks.append(f"5. {total} –∫–æ–Ω—Ñ–µ—Ç —Ä–∞–∑–¥–∞–ª–∏ –ø–æ—Ä–æ–≤–Ω—É {groups} –¥–µ—Ç—è–º. –°–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–µ—Ç —É –∫–∞–∂–¥–æ–≥–æ?")

    # 6. –†–∞–∑–Ω–æ—Å—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    n1, n2 = random.randint(30, 99), random.randint(10, 80)
    if n1 < n2:
        n1, n2 = n2, n1
    tasks.append(f"6. –ù–∞ —Å–∫–æ–ª—å–∫–æ {n1} –±–æ–ª—å—à–µ, —á–µ–º {n2}?")

    # 7. –ü–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞
    side = random.randint(5, 12)
    tasks.append(f"7. –ù–∞–π–¥–∏ –ø–µ—Ä–∏–º–µ—Ç—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω–æ–π {side} —Å–º.")

    # 8. –°–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º
    known = random.randint(20, 60)
    total = random.randint(known + 10, min(100, known + 40))
    tasks.append(f"8. –ö–∞–∫–æ–µ —á–∏—Å–ª–æ –Ω–∞–¥–æ –ø—Ä–∏–±–∞–≤–∏—Ç—å –∫ {known}, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å {total}?")

    # 9. –£—Ä–∞–≤–Ω–µ–Ω–∏–µ
    b_val = random.randint(15, 50)
    result = random.randint(b_val + 10, 100)
    tasks.append(f"9. –†–µ—à–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: x + {b_val} = {result}")

    # 10. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    op1 = random.randint(2, 9) * random.randint(3, 8)
    op2 = random.randint(2, 9) * random.randint(3, 8)
    tasks.append(f"10. –°—Ä–∞–≤–Ω–∏: {op1} ‚òê {op2} (–ø–æ—Å—Ç–∞–≤—å >, < –∏–ª–∏ =)")

    return "\n".join(tasks)

def generate_russian_tasks():
    words = ["—Ç—Ä...–≤–∞", "–¥...–∂—É—Ä–Ω—ã–π", "–ø...–ª—å—Ç–æ", "–º...—Ä–æ–∑", "–≥—Ä...–∑–∞", "—Å...–ø–æ–≥–∏", "–≤...—Ä–æ–Ω–∞", "–∑...–≤–æ–¥"]
    chosen = random.sample(words, 5)
    task1 = "1. –í—Å—Ç–∞–≤—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã: " + ", ".join(chosen) + "."
    task2 = "2. –ü–æ–¥—á–µ—Ä–∫–Ω–∏ –≥–ª–∞–≤–Ω—ã–µ —á–ª–µ–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ¬´–õ–∏—Å–∞ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ –∫—Ä–∞–¥—ë—Ç—Å—è –ø–æ —Å–Ω–µ–≥—É.¬ª"
    task3 = "3. –í—ã–¥–µ–ª–∏ –∫–æ—Ä–µ–Ω—å –≤ —Å–ª–æ–≤–∞—Ö: " + ", ".join(random.sample(["–≥–æ—Ä–∞", "–≥–æ—Ä–Ω—ã–π", "–ø—Ä–∏–≥–æ—Ä–æ–∫"], 3)) + "."
    return "\n".join([task1, task2, task3])

def generate_english_tasks():
    articles = [("apple", "an"), ("umbrella", "an"), ("book", "a"), ("elephant", "an"), ("cat", "a")]
    chosen = random.sample(articles, 3)
    blanks = "\n   ".join([f"‚Äî ___ {word}" for word, _ in chosen])
    task1 = "1. –í—Å—Ç–∞–≤—å **a** –∏–ª–∏ **an**:\n   " + blanks

    subjects = ["I", "He", "She", "We"]
    verbs = ["like", "play", "eat", "read"]
    objects = ["ice cream", "football", "books", "piano"]
    s1 = f"{random.choice(subjects)} / {random.choice(verbs)} / {random.choice(objects)}"
    s2 = f"{random.choice(subjects)} / {random.choice(verbs)} / {random.choice(objects)}"
    task2 = f"2. –°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:\n   ‚Äî {s1} ‚Üí ________________________\n   ‚Äî {s2} ‚Üí ________________________"

    return "\n\n".join([task1, task2])

# === –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î–´ ===

@router.message(Command("test", "—Ç–µ—Å—Ç"))
async def send_test(message: Message):
    math = "üß† **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞**\n" + generate_math_tasks()
    rus = "\n\nüî§ **–†—É—Å—Å–∫–∏–π —è–∑—ã–∫**\n" + generate_russian_tasks()
    eng = "\n\nüåç **–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫**\n" + generate_english_tasks()
    full_test = math + rus + eng
    await message.answer(full_test, parse_mode="Markdown")

# === –ó–ê–ü–£–°–ö ===

async def main():
    dp.include_router(router)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
